<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>生理周期カレンダー</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      #calendar { max-width: 900px; margin: 40px auto; }
    </style>
</head>
<body>
    <h1>生理周期カレンダー</h1>
    <form id="cycle-form" class="input-form">
        <label>生理周期データ（カンマ区切り）:</label>
        <input type="text" name="cycle_data" id="cycle_data" value="{{ default_data }}" size="40">
        <br>
        <label>最後の生理が始まった日:</label>
        <input type="date" name="start_date" id="start_date" value="{{ default_start_date }}">
        <br>
        <button type="submit">送信</button>
    </form>
    <div id="stats-area"></div>
    <h2>カレンダー</h2>
    <div id="calendar"></div>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            height: 650,
            events: []
        });
        calendar.render();

        function renderStats(stats) {
            const statsArea = document.getElementById('stats-area');
            if (!stats) {
                statsArea.innerHTML = '';
                return;
            }
            if (stats.error) {
                statsArea.innerHTML = `<p style="color:red;">エラー: ${stats.error}</p>`;
            } else {
                statsArea.innerHTML = `<h2>統計情報</h2><ul><li>平均周期: ${stats.mean} 日</li><li>標準偏差: ${stats.std} 日</li></ul>`;
            }
        }

        function fetchAndRenderEvents() {
            const cycle_data = document.getElementById('cycle_data').value;
            const start_date = document.getElementById('start_date').value;
            fetch('/api/calendar_data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cycle_data, start_date })
            })
            .then(response => response.json())
            .then(data => {
                if (data.events) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(data.events);
                }
                if (data.stats) {
                    renderStats(data.stats);
                }
            });
        }

        // 初回表示
        fetchAndRenderEvents();

        // フォーム送信時にAPIを叩いてカレンダー・統計情報更新
        document.getElementById('cycle-form').addEventListener('submit', function(e) {
            e.preventDefault();
            fetchAndRenderEvents();
        });
    });
    </script>
</body>
</html>